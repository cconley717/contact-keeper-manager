<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contact Keeper Manager</title>

    <!-- Styles -->
    <link rel="stylesheet" href="/css/style.css" />

    <!-- AG-Grid JavaScript (includes all CSS) -->
    <script src="/js/ag-grid-community.min.js"></script>
  </head>
  <body>
    <!-- Update Contact Modal -->
    <div id="updateModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Update Contact</h2>
          <button type="button" class="modal-close" onclick="closeUpdateModal()" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-form-grid">
          <div>
            <label class="form-label" for="updateContactId">Contact ID *</label>
            <input
              type="number"
              id="updateContactId"
              class="form-input"
              required
            />
          </div>
          <div>
            <label class="form-label" for="updateFirstName">First Name *</label>
            <input
              type="text"
              id="updateFirstName"
              class="form-input"
              required
            />
          </div>
          <div>
            <label class="form-label" for="updateLastName">Last Name *</label>
            <input
              type="text"
              id="updateLastName"
              class="form-input"
              required
            />
          </div>
          <div>
            <label class="form-label" for="updateProgram">Program</label>
            <input type="text" id="updateProgram" class="form-input" />
          </div>
          <div>
            <label class="form-label" for="updateEmail">Email Address *</label>
            <input type="email" id="updateEmail" class="form-input" required />
          </div>
          <div>
            <label class="form-label" for="updatePhone">Phone</label>
            <input type="tel" id="updatePhone" class="form-input" />
          </div>
          <div>
            <label class="form-label" for="updateCreatedDate">Contact Created Date *</label>
            <input
              type="text"
              id="updateCreatedDate"
              class="form-input"
              required
            />
          </div>
          <div>
            <label class="form-label" for="updateAction">Action</label>
            <input type="text" id="updateAction" class="form-input" />
          </div>
          <div>
            <label class="form-label" for="updateLawFirmId">Law Firm ID *</label>
            <input
              type="number"
              id="updateLawFirmId"
              class="form-input"
              required
            />
          </div>
          <div>
            <label class="form-label" for="updateLawFirmName">Law Firm Name *</label>
            <input
              type="text"
              id="updateLawFirmName"
              class="form-input"
              required
            />
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeUpdateModal()">
            Cancel
          </button>
          <button class="btn-success" onclick="saveUpdatedContact()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <h1>Contact Keeper Manager</h1>

      <!-- Upload Section -->
      <div class="upload-section">
        <h2>Import CSV File</h2>
        <div class="file-input-wrapper">
          <input type="file" id="csvFile" accept=".csv" />
          <button id="uploadBtn" class="btn-primary">Upload & Import</button>
        </div>
        <div id="uploadMessage"></div>
      </div>

      <!-- Add New Contact and Client ID Management (Side-by-Side) -->
      <div class="side-by-side-container">
        <!-- Add New Contact Section -->
        <div class="side-by-side-item">
          <h2 class="collapsible-header" id="addContactToggle">
            <span id="addContactIcon" class="collapsible-icon">▶</span>
            Add New Contact
          </h2>
          <div id="addContactForm" class="collapsible-content">
            <div class="form-grid">
              <div class="form-field">
                <label class="form-label" for="newContactId">Contact ID *</label>
                <input
                  type="number"
                  id="newContactId"
                  class="form-input"
                  required
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="newFirstName">First Name *</label>
                <input
                  type="text"
                  id="newFirstName"
                  class="form-input"
                  required
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="newLastName">Last Name *</label>
                <input type="text" id="newLastName" class="form-input" required />
              </div>
              <div class="form-field">
                <label class="form-label" for="newProgram">Program</label>
                <input type="text" id="newProgram" class="form-input" />
              </div>
              <div class="form-field">
                <label class="form-label" for="newEmail">Email Address *</label>
                <input type="email" id="newEmail" class="form-input" required />
              </div>
              <div class="form-field">
                <label class="form-label" for="newPhone">Phone</label>
                <input type="text" id="newPhone" class="form-input" />
              </div>
              <div class="form-field">
                <label class="form-label" for="newCreatedDate">Contact Created Date *</label>
                <input
                  type="text"
                  id="newCreatedDate"
                  class="form-input"
                  placeholder="MM/DD/YYYY"
                  required
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="newAction">Action</label>
                <input type="text" id="newAction" class="form-input" />
              </div>
              <div class="form-field">
                <label class="form-label" for="newLawFirmId">Law Firm ID *</label>
                <input
                  type="number"
                  id="newLawFirmId"
                  class="form-input"
                  required
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="newLawFirmName">Law Firm Name *</label>
                <input
                  type="text"
                  id="newLawFirmName"
                  class="form-input"
                  required
                />
              </div>
            </div>
            <button id="addContactBtn" class="btn-success btn-large">
              Add Contact
            </button>
            <div id="addContactMessage"></div>
          </div>
        </div>

        <!-- Add Client ID Section -->
        <div class="side-by-side-item">
          <h2 class="collapsible-header" id="addClientToggle">
            <span id="addClientIcon" class="collapsible-icon">▶</span>
            Manage Client IDs
          </h2>
          <div id="addClientForm" class="collapsible-content">
            <div class="form-grid">
              <div class="form-field">
                <label class="form-label" for="newClientIdInput">Client ID *</label>
                <input
                  type="number"
                  id="newClientIdInput"
                  class="form-input"
                  min="1"
                  step="1"
                  required
                />
              </div>
            </div>
            <button id="addClientIdBtn" class="btn-success btn-large">
              Add Client ID
            </button>
            <div id="addClientMessage"></div>
            
            <!-- List of existing client IDs -->
            <div id="clientIdList" class="client-list"></div>
          </div>
        </div>
      </div>

      <!-- Data Grid Section -->
      <div class="grid-section">
        <h2>Contact Database</h2>
        <div class="search-bar">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Search across all columns..."
            autocomplete="off"
          />
          <button id="searchBtn" class="btn-primary ml-10">Search</button>
          <button id="clearSearchBtn" class="btn-secondary ml-5">Clear</button>
        </div>
        <div id="dataGrid"></div>
      </div>

      <!-- Output Table Section -->
      <div class="output-section">
        <div class="output-header">
          <h2 class="output-header__title">Output Table</h2>
        </div>
        <table class="output-table">
          <tbody>
            <tr>
              <th>Client ID</th>
              <td><select data-field="client_id" id="outputClientIdSelect"></select></td>
            </tr>
            <tr>
              <th>Contact ID</th>
              <td><input type="text" data-field="contact_id" /></td>
            </tr>
            <tr>
              <th>Topic</th>
              <td>
                <select data-field="topic">
                  <option value=""></option>
                  <option value="General Information">
                    General Information
                  </option>
                  <option value="Payment Information">
                    Payment Information
                  </option>
                  <option value="Portal Navigation">Portal Navigation</option>
                  <option value="EIF Question">EIF Question</option>
                  <option value="EPP Question">EPP Question</option>
                  <option value="FIFO Question">FIFO Question</option>
                  <option value="DPP Question">DPP Question</option>
                  <option value="Bankruptcy Question">
                    Bankruptcy Question
                  </option>
                  <option value="Liens Question">Liens Question</option>
                  <option value="Consortium Question">
                    Consortium Question
                  </option>
                  <option value="Ledgering Question">Ledgering Question</option>
                  <option value="Report Question">Report Question</option>
                  <option value="Attorney Representation Related">
                    Attorney Representation Related
                  </option>
                  <option value="Notice Question">Notice Question</option>
                </select>
              </td>
            </tr>
            <tr>
              <th>Firm ID(s)</th>
              <td><input type="text" data-field="law_firm_id" /></td>
            </tr>
            <tr>
              <th>Claimant ID(s)</th>
              <td><input type="text" data-field="claimant_id" /></td>
            </tr>
            <tr>
              <th>Inbound/Outbound</th>
              <td>
                <select data-field="inbound_outbound">
                  <option value=""></option>
                  <option value="Inbound">Inbound</option>
                  <option value="Outbound">Outbound</option>
                </select>
              </td>
            </tr>
            <tr>
              <th>Outreach</th>
              <td>
                <select data-field="outreach">
                  <option value=""></option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </td>
            </tr>
            <tr>
              <th>Communication Method</th>
              <td>
                <select data-field="communication_method">
                  <option value=""></option>
                  <option value="Email">Email</option>
                </select>
              </td>
            </tr>
            <tr>
              <th>Start of Message:</th>
              <td><input type="text" data-field="message" /></td>
            </tr>
          </tbody>
        </table>
      </div>
      <br />
      <button id="copyOutputBtn" class="btn-info">Copy to Clipboard</button>
    </div>

    <script>
      let currentPage = 0;
      let currentSearch = "";
      let currentSort = null;

      // Grid configuration with Theming API
      const gridOptions = {
        theme: agGrid.themeQuartz,
        columnDefs: [
          {
            field: "actions",
            headerName: "",
            width: 260,
            cellRenderer: function (params) {
              return `
              <button class="select-btn">Select</button>
              <button class="update-btn">Update</button>
              <button class="delete-btn">Delete</button>
            `;
            },
            onCellClicked: function (params) {
              const rowData = params.data;
              const target = params.event.target;

              if (target.classList.contains("select-btn")) {
                // Populate Contact ID field
                document.querySelector(
                  '.output-section input[data-field="contact_id"]'
                ).value = rowData.contact_id || "";

                // Populate Firm ID field
                document.querySelector(
                  '.output-section input[data-field="law_firm_id"]'
                ).value = rowData.law_firm_id || "";
              } else if (target.classList.contains("update-btn")) {
                // Open update modal
                openUpdateModal(rowData);
              } else if (target.classList.contains("delete-btn")) {
                // Delete contact
                deleteContact(rowData.contact_id);
              }
            },
            sortable: false,
            filter: false,
          },
          {
            field: "contact_id",
            headerName: "Contact ID",
            width: 120,
            filter: true,
            sortable: true,
          },
          {
            field: "first_name",
            headerName: "First Name",
            width: 140,
            filter: true,
            sortable: true,
          },
          {
            field: "last_name",
            headerName: "Last Name",
            width: 140,
            filter: true,
            sortable: true,
          },
          {
            field: "program",
            headerName: "Program",
            width: 180,
            filter: true,
            sortable: true,
          },
          {
            field: "email_address",
            headerName: "Email Address",
            width: 220,
            filter: true,
            sortable: true,
          },
          {
            field: "phone",
            headerName: "Phone",
            width: 150,
            filter: true,
            sortable: true,
          },
          {
            field: "contact_created_date",
            headerName: "Created Date",
            width: 130,
            filter: true,
            sortable: true,
          },
          {
            field: "law_firm_id",
            headerName: "Firm ID",
            width: 100,
            filter: true,
            sortable: true,
          },
          {
            field: "law_firm_name",
            headerName: "Law Firm",
            width: 200,
            filter: true,
            sortable: true,
          },
          {
            field: "action",
            headerName: "Action",
            width: 100,
            filter: true,
            sortable: true,
          },
        ],
        defaultColDef: {
          resizable: true,
          sortable: true,
          filter: true,
        },
        onGridReady: function (params) {
          loadData();
        },
        onSortChanged: function (params) {
          const sortModel = params.api.getColumnState().find((col) => col.sort);
          if (sortModel) {
            currentSort = {
              field: sortModel.colId,
              order: sortModel.sort,
            };
          } else {
            currentSort = null;
          }
          currentServerPage = 0;
          loadData();
        },
      };

      // Initialize grid
      const gridDiv = document.querySelector("#dataGrid");
      const gridApi = agGrid.createGrid(gridDiv, gridOptions);

      let totalRowCount = 0;
      let currentServerPage = 0;

      // Search functionality
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const clearSearchBtn = document.getElementById("clearSearchBtn");

      searchBtn.addEventListener("click", function () {
        currentSearch = searchInput.value.trim();
        currentServerPage = 0;
        loadData();
      });

      clearSearchBtn.addEventListener("click", function () {
        searchInput.value = "";
        currentSearch = "";
        currentServerPage = 0;
        loadData();
      });

      // Allow Enter key to search
      searchInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          searchBtn.click();
        }
      });

      // Pre-populate Contact Created Date with today's date
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      const year = today.getFullYear();
      document.getElementById(
        "newCreatedDate"
      ).value = `${month}/${day}/${year}`;

      // Toggle Add Contact form
      const addContactToggle = document.getElementById("addContactToggle");
      const addContactForm = document.getElementById("addContactForm");
      const addContactIcon = document.getElementById("addContactIcon");

      addContactToggle.addEventListener("click", function () {
        addContactForm.classList.toggle("collapsible-content--visible");
        addContactIcon.textContent = addContactForm.classList.contains(
          "collapsible-content--visible"
        )
          ? "▼"
          : "▶";
      });

      // Toggle Add Client ID form
      const addClientToggle = document.getElementById("addClientToggle");
      const addClientForm = document.getElementById("addClientForm");
      const addClientIcon = document.getElementById("addClientIcon");

      addClientToggle.addEventListener("click", function () {
        addClientForm.classList.toggle("collapsible-content--visible");
        addClientIcon.textContent = addClientForm.classList.contains(
          "collapsible-content--visible"
        )
          ? "▼"
          : "▶";
      });

      // Load client IDs from server
      async function loadClients() {
        try {
          const response = await fetch("/api/clients");
          const clients = await response.json();

          // Populate the output table dropdown
          const outputSelect = document.getElementById("outputClientIdSelect");
          outputSelect.innerHTML = "";
          
          // Add empty default option
          const emptyOption = document.createElement("option");
          emptyOption.value = "";
          emptyOption.textContent = "";
          outputSelect.appendChild(emptyOption);
          
          clients.forEach((client) => {
            const option = document.createElement("option");
            option.value = client.client_id;
            option.textContent = client.client_id;
            outputSelect.appendChild(option);
          });

          // Update the client ID list in the management section
          const clientList = document.getElementById("clientIdList");
          if (clients.length === 0) {
            clientList.innerHTML = "<p class='no-clients-message'>No client IDs yet. Add one above!</p>";
          } else {
            clientList.innerHTML = "<h3>Existing Client IDs:</h3>";
            const listContainer = document.createElement("div");
            listContainer.className = "client-items";

            clients.forEach((client) => {
              const clientItem = document.createElement("div");
              clientItem.className = "client-item";
              
              const clientIdSpan = document.createElement("span");
              clientIdSpan.className = "client-item__id";
              clientIdSpan.textContent = client.client_id;
              
              const deleteBtn = document.createElement("button");
              deleteBtn.className = "btn-danger btn-small";
              deleteBtn.textContent = "Delete";
              deleteBtn.onclick = () => deleteClient(client.id, client.client_id);
              
              clientItem.appendChild(clientIdSpan);
              clientItem.appendChild(deleteBtn);
              listContainer.appendChild(clientItem);
            });

            clientList.appendChild(listContainer);
          }
        } catch (error) {
          console.error("Error loading clients:", error);
        }
      }

      // Add new client ID
      const addClientIdBtn = document.getElementById("addClientIdBtn");
      const addClientMessage = document.getElementById("addClientMessage");
      const newClientIdInput = document.getElementById("newClientIdInput");

      // Helper function to show client messages with auto-dismiss
      function showClientMessage(message, type) {
        addClientMessage.innerHTML = `<p class="message message--${type}">${message}</p>`;
        setTimeout(() => {
          addClientMessage.innerHTML = "";
        }, 3000);
      }

      addClientIdBtn.addEventListener("click", async function () {
        const clientId = Number.parseInt(newClientIdInput.value.trim());

        // Validation
        if (!clientId || clientId <= 0) {
          showClientMessage("Please enter a positive client ID", "error");
          return;
        }

        addClientIdBtn.disabled = true;
        addClientIdBtn.textContent = "Adding...";

        try {
          const response = await fetch("/api/clients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ client_id: clientId }),
          });

          const data = await response.json();

          if (response.ok) {
            showClientMessage(data.message, "success");
            newClientIdInput.value = "";
            await loadClients(); // Refresh the list and dropdown
          } else {
            showClientMessage(data.error || "Failed to add client ID", "error");
          }
        } catch (error) {
          console.error("Error adding client:", error);
          showClientMessage("Failed to add client ID. Please try again.", "error");
        } finally {
          addClientIdBtn.disabled = false;
          addClientIdBtn.textContent = "Add Client ID";
        }
      });

      // Delete client ID
      async function deleteClient(id, clientId) {
        if (!confirm(`Delete client ID ${clientId}?`)) {
          return;
        }

        try {
          const response = await fetch(`/api/clients/${id}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (response.ok) {
            showClientMessage(data.message, "success");
            await loadClients(); // Refresh the list and dropdown
          } else {
            showClientMessage(data.error || "Failed to delete client ID", "error");
          }
        } catch (error) {
          console.error("Error deleting client:", error);
          showClientMessage("Failed to delete client ID. Please try again.", "error");
        }
      }

      // Load clients on page load
      loadClients();

      // Delete contact function
      async function deleteContact(contactId) {
        if (
          !confirm(
            `Are you sure you want to delete contact ID ${contactId}? This action cannot be undone.`
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/api/contact/${contactId}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (response.ok) {
            // Refresh grid
            loadData();
          } else {
            alert(data.error || "Failed to delete contact");
          }
        } catch (error) {
          console.error("Error deleting contact:", error);
          alert("Failed to delete contact. Please try again.");
        }
      }

      // Update contact modal functions
      let originalContactId = null; // Store the original contact ID

      function openUpdateModal(contactData) {
        originalContactId = contactData.contact_id; // Store original ID

        document.getElementById("updateContactId").value =
          contactData.contact_id || "";
        document.getElementById("updateFirstName").value =
          contactData.first_name || "";
        document.getElementById("updateLastName").value =
          contactData.last_name || "";
        document.getElementById("updateProgram").value =
          contactData.program || "";
        document.getElementById("updateEmail").value =
          contactData.email_address || "";
        document.getElementById("updatePhone").value = contactData.phone || "";
        document.getElementById("updateCreatedDate").value =
          contactData.contact_created_date || "";
        document.getElementById("updateAction").value =
          contactData.action || "";
        document.getElementById("updateLawFirmId").value =
          contactData.law_firm_id || "";
        document.getElementById("updateLawFirmName").value =
          contactData.law_firm_name || "";

        document.getElementById("updateModal").classList.add("modal--visible");
      }

      function closeUpdateModal() {
        document
          .getElementById("updateModal")
          .classList.remove("modal--visible");
        originalContactId = null; // Clear stored ID
      }

      async function saveUpdatedContact() {
        const contactData = {
          contact_id: Number.parseInt(
            document.getElementById("updateContactId").value
          ),
          first_name: document.getElementById("updateFirstName").value.trim(),
          last_name: document.getElementById("updateLastName").value.trim(),
          program: document.getElementById("updateProgram").value.trim(),
          email_address: document.getElementById("updateEmail").value.trim(),
          phone: document.getElementById("updatePhone").value.trim(),
          contact_created_date: document
            .getElementById("updateCreatedDate")
            .value.trim(),
          action: document.getElementById("updateAction").value.trim(),
          law_firm_id: document.getElementById("updateLawFirmId").value
            ? Number.parseInt(document.getElementById("updateLawFirmId").value)
            : null,
          law_firm_name: document
            .getElementById("updateLawFirmName")
            .value.trim(),
        };

        // Validation
        if (
          !contactData.contact_id ||
          !contactData.first_name ||
          !contactData.last_name ||
          !contactData.email_address ||
          !contactData.contact_created_date ||
          !contactData.law_firm_id ||
          !contactData.law_firm_name
        ) {
          alert("Please fill in all required fields (marked with *)");
          return;
        }

        try {
          const response = await fetch(`/api/contact/${originalContactId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(contactData),
          });

          const data = await response.json();

          if (response.ok) {
            closeUpdateModal();
            loadData();
          } else {
            alert(data.error || "Failed to update contact");
          }
        } catch (error) {
          console.error("Error updating contact:", error);
          alert("Failed to update contact. Please try again.");
        }
      }

      // Close modal when clicking outside of it
      globalThis.onclick = function (event) {
        const modal = document.getElementById("updateModal");
        if (event.target === modal) {
          closeUpdateModal();
        }
      };

      // Load data from server with server-side pagination
      async function loadData() {
        try {
          // Use our own page tracking since we're doing server-side pagination
          let url = `/api/contacts?page=${currentServerPage}&pageSize=20`;

          if (currentSort) {
            url += `&sortField=${currentSort.field}&sortOrder=${currentSort.order}`;
          }

          if (currentSearch) {
            url += `&search=${encodeURIComponent(currentSearch)}`;
          }

          const response = await fetch(url);
          const data = await response.json();

          totalRowCount = data.totalCount;

          // Set row data for this page only
          gridApi.setGridOption("rowData", data.data);
          gridApi.setGridOption("pagination", false); // Disable built-in pagination

          // Update custom pagination display
          updatePaginationDisplay();
        } catch (error) {
          console.error("Error loading data:", error);
        }
      }

      function updatePaginationDisplay() {
        const totalPages = Math.ceil(totalRowCount / 20);
        const startRow = currentServerPage * 20 + 1;
        const endRow = Math.min((currentServerPage + 1) * 20, totalRowCount);

        let paginationHtml = `
        <div class="pagination-container">
          <div class="pagination-info">Showing ${startRow}-${endRow} of ${totalRowCount}</div>
          <div class="pagination-controls">
            <button class="btn-primary" onclick="goToPage(0)" ${
              currentServerPage === 0 ? "disabled" : ""
            }>First</button>
            <button class="btn-primary" onclick="goToPage(${
              currentServerPage - 1
            })" ${currentServerPage === 0 ? "disabled" : ""}>Previous</button>
            <span>Page ${currentServerPage + 1} of ${totalPages}</span>
            <button class="btn-primary" onclick="goToPage(${
              currentServerPage + 1
            })" ${
          currentServerPage >= totalPages - 1 ? "disabled" : ""
        }>Next</button>
            <button class="btn-primary" onclick="goToPage(${totalPages - 1})" ${
          currentServerPage >= totalPages - 1 ? "disabled" : ""
        }>Last</button>
          </div>
        </div>
      `;

        // Add or update pagination container
        let paginationDiv = document.getElementById("customPagination");
        if (!paginationDiv) {
          paginationDiv = document.createElement("div");
          paginationDiv.id = "customPagination";
          document.querySelector(".grid-section").appendChild(paginationDiv);
        }
        paginationDiv.innerHTML = paginationHtml;
      }

      function goToPage(page) {
        currentServerPage = page;
        loadData();
      }

      // Add new contact functionality
      const addContactBtn = document.getElementById("addContactBtn");
      const addContactMessage = document.getElementById("addContactMessage");

      addContactBtn.addEventListener("click", async function () {
        const contactData = {
          contact_id: Number.parseInt(
            document.getElementById("newContactId").value
          ),
          first_name: document.getElementById("newFirstName").value.trim(),
          last_name: document.getElementById("newLastName").value.trim(),
          program: document.getElementById("newProgram").value.trim(),
          email_address: document.getElementById("newEmail").value.trim(),
          phone: document.getElementById("newPhone").value.trim(),
          contact_created_date: document
            .getElementById("newCreatedDate")
            .value.trim(),
          action: document.getElementById("newAction").value.trim(),
          law_firm_id: document.getElementById("newLawFirmId").value
            ? Number.parseInt(document.getElementById("newLawFirmId").value)
            : null,
          law_firm_name: document.getElementById("newLawFirmName").value.trim(),
        };

        // Validate required fields
        if (
          !contactData.contact_id ||
          !contactData.first_name ||
          !contactData.last_name ||
          !contactData.email_address ||
          !contactData.contact_created_date ||
          !contactData.law_firm_id ||
          !contactData.law_firm_name
        ) {
          showAddContactMessage(
            "Contact ID, First Name, Last Name, Email Address, Contact Created Date, Law Firm ID, and Law Firm Name are required",
            "error"
          );
          return;
        }

        addContactBtn.disabled = true;
        addContactBtn.textContent = "Adding...";

        try {
          const response = await fetch("/api/contact", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(contactData),
          });

          const data = await response.json();

          if (response.ok) {
            showAddContactMessage(data.message, "success");

            // Clear form
            document.getElementById("newContactId").value = "";
            document.getElementById("newFirstName").value = "";
            document.getElementById("newLastName").value = "";
            document.getElementById("newProgram").value = "";
            document.getElementById("newEmail").value = "";
            document.getElementById("newPhone").value = "";
            document.getElementById("newCreatedDate").value = "";
            document.getElementById("newAction").value = "";
            document.getElementById("newLawFirmId").value = "";
            document.getElementById("newLawFirmName").value = "";

            // Refresh grid
            currentServerPage = 0;
            loadData();
          } else {
            showAddContactMessage(
              data.error || "Failed to add contact",
              "error"
            );
          }
        } catch (error) {
          console.error("Error adding contact:", error);
          showAddContactMessage(
            "Failed to add contact. Please try again.",
            "error"
          );
        } finally {
          addContactBtn.disabled = false;
          addContactBtn.textContent = "Add Contact";
        }
      });

      function showAddContactMessage(message, type) {
        addContactMessage.innerHTML = `<div class="message message--${type}">${message}</div>`;
        setTimeout(() => {
          addContactMessage.innerHTML = "";
        }, 3000);
      }

      // File upload functionality
      const uploadBtn = document.getElementById("uploadBtn");
      const csvFile = document.getElementById("csvFile");
      const uploadMessage = document.getElementById("uploadMessage");

      uploadBtn.addEventListener("click", async function () {
        const file = csvFile.files[0];

        if (!file) {
          showMessage("Please select a CSV file", "error");
          return;
        }

        if (!file.name.endsWith(".csv")) {
          showMessage("Please select a valid CSV file", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        uploadBtn.disabled = true;
        uploadBtn.textContent = "Uploading...";
        uploadMessage.innerHTML = "";

        try {
          const response = await fetch("/api/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (response.ok) {
            showMessage(data.message, "success");
            csvFile.value = "";

            // Refresh grid
            currentPage = 0;
            loadData();
          } else {
            showMessage(data.error || "Upload failed", "error");
          }
        } catch (error) {
          console.error("Upload error:", error);
          showMessage("Upload failed. Please try again.", "error");
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.textContent = "Upload & Import";
        }
      });

      function showMessage(message, type) {
        uploadMessage.innerHTML = `<div class="message message--${type}">${message}</div>`;
        setTimeout(() => {
          uploadMessage.innerHTML = "";
        }, 3000);
      }

      // Copy Output Table to Clipboard
      const copyOutputBtn = document.getElementById("copyOutputBtn");

      copyOutputBtn.addEventListener("click", async function () {
        try {
          // Get all the field values from the output table
          const clientId = document.querySelector(
            '.output-section select[data-field="client_id"]'
          ).value;
          const contactId = document.querySelector(
            '.output-section input[data-field="contact_id"]'
          ).value;
          const topic = document.querySelector(
            '.output-section select[data-field="topic"]'
          ).value;
          const firmId = document.querySelector(
            '.output-section input[data-field="law_firm_id"]'
          ).value;
          const claimantId = document.querySelector(
            '.output-section input[data-field="claimant_id"]'
          ).value;
          const inboundOutbound = document.querySelector(
            '.output-section select[data-field="inbound_outbound"]'
          ).value;
          const outreach = document.querySelector(
            '.output-section select[data-field="outreach"]'
          ).value;
          const commMethod = document.querySelector(
            '.output-section select[data-field="communication_method"]'
          ).value;
          const message = document.querySelector(
            '.output-section input[data-field="message"]'
          ).value;

          // Create minimal HTML table with inline styles for clipboard (external CSS won't work)
          const htmlTable = `
<table style="border: 1px solid #000; border-collapse: collapse;">
  <tbody>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Client ID</td>
      <td style="border: 1px solid #000; padding: 4px;">${clientId}</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Contact ID</td>
      <td style="border: 1px solid #000; padding: 4px;">${contactId}</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Topic</td>
      <td style="border: 1px solid #000; padding: 4px;">${topic}</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Firm ID(s)</td>
      <td style="border: 1px solid #000; padding: 4px;">${firmId}</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Claimant ID(s)</td>
      <td style="border: 1px solid #000; padding: 4px;">${claimantId}</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Inbound/Outbound</td>
      <td style="border: 1px solid #000; padding: 4px;">${inboundOutbound}</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Outreach</td>
      <td style="border: 1px solid #000; padding: 4px;">${outreach}</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Communication Method</td>
      <td style="border: 1px solid #000; padding: 4px;">${commMethod}</td>
    </tr>
    <tr>
      <td style="border: 1px solid #000; padding: 4px;">Start of Message:</td>
      <td style="border: 1px solid #000; padding: 4px;">${message}</td>
    </tr>
  </tbody>
</table>`;

          // Also create plain text version for apps that don't support HTML
          const plainText = [
            ["Client ID", clientId],
            ["Contact ID", contactId],
            ["Topic", topic],
            ["Firm ID(s)", firmId],
            ["Claimant ID(s)", claimantId],
            ["Inbound/Outbound", inboundOutbound],
            ["Outreach", outreach],
            ["Communication Method", commMethod],
            ["Start of Message:", message],
          ]
            .map((row) => row.join("\t"))
            .join("\n");

          // Copy both HTML and plain text to clipboard
          const clipboardItem = new ClipboardItem({
            "text/html": new Blob([htmlTable], { type: "text/html" }),
            "text/plain": new Blob([plainText], { type: "text/plain" }),
          });

          await navigator.clipboard.write([clipboardItem]);

          // Visual feedback
          const originalText = copyOutputBtn.textContent;
          copyOutputBtn.textContent = "✓ Copied!";
          copyOutputBtn.classList.add("btn-info--copied");

          setTimeout(() => {
            copyOutputBtn.textContent = originalText;
            copyOutputBtn.classList.remove("btn-info--copied");
          }, 2000);
        } catch (error) {
          console.error("Error copying to clipboard:", error);
          alert("Failed to copy to clipboard. Please try again.");
        }
      });
    </script>
  </body>
</html>
